#!/bin/bash

psql="psql -t -d results -U hadoop -c "
query="select distinct query from disk order by query;"

if ! test -d /tmp/autoconf/plot/; then
    mkdir /tmp/autoconf/plot
fi

for stage in $(${psql} "${query}"); do
    s=$(sed s/\'/\'\'/g <<< ${stage})
    png="/tmp/autoconf/plot/${s}.disk.png"
    s=$(sed s/%/\\\\%/g <<< ${s})
    output="/tmp/autoconf/plot/${s}.disk"

    $psql "COPY (SELECT time - (SELECT min(time) FROM disk),
           avg(tps) AS Free,
           avg(bulk_read) AS Bulk_Read,
           avg(bulk_written) AS Bulk_Written
           FROM disk
           WHERE time IN (SELECT time FROM disk)
            AND query LIKE '${s}'
            AND tps IS NOT NULL
            AND bulk_read IS NOT NULL
            AND bulk_written IS NOT NULL
           GROUP BY query, time ORDER BY time) TO '${output}' WITH CSV;"

   gnuplot <<< "set title '$s'
   set term png
   set datafile separator ','
   set output '$png'
   set xlabel 'Time'
   set xrange [0:350]
   set ylabel 'DISK Usage'
   set yrange [0:25000]
   set style data lines
   plot '$output' using 2 title 'I/O request per second',\\
        '$output' using 3 title 'Bulk read per second',\\
        '$output' using 4 title 'Bulk written per second'" &
done
