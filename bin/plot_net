#!/bin/bash

psql="psql -t -d results -U hadoop -c "
query="select distinct query from net order by query;"

if ! test -d /tmp/autoconf/plot/; then
    mkdir /tmp/autoconf/plot
fi

for stage in $(${psql} "${query}"); do
    s=$(sed s/\'/\'\'/g <<< ${stage})
    png="/tmp/autoconf/plot/${s}.net.png"
    s=$(sed s/%/\\\\%/g <<< ${s})
    output="/tmp/autoconf/plot/${s}.net"

    $psql "COPY (SELECT time - (SELECT min(time) FROM net),
           avg(pkt_received),
           avg(pkt_transmitted),
           avg(kb_received),
           avg(kb_transmitted),
           avg(cpkt_received),
           avg(cpkt_transmitted)
           FROM net
           WHERE time IN (SELECT time FROM net)
            AND query LIKE '${s}'
            AND pkt_received IS NOT NULL
            AND pkt_transmitted IS NOT NULL
            AND kb_received IS NOT NULL
            AND kb_transmitted IS NOT NULL
            AND cpkt_received IS NOT NULL
            AND cpkt_transmitted IS NOT NULL
           GROUP BY query, time ORDER BY time) TO '${output}' WITH CSV;"

  gnuplot <<< "set title '$s'
  set term png
  set datafile separator ','
  set output '$png'
  set xlabel 'Time'
  set xrange [0:10000]
  set ylabel 'Memory size (bytes)'
  set yrange [0:100000]
  set style data lines
  plot '$output' using 2 title 'Packet Received/s',\\
       '$output' using 3 title 'Packet Transmitted/s',\\
       '$output' using 4 title 'Kb Received/s',\\
       '$output' using 5 title 'Kb Transmitted/s',\\
       '$output' using 6 title 'Compressed Pkt Received/s',\\
       '$output' using 7 title 'Compressed Pkt Transmitted/s'" &
done
